!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).rtcbot={})}(this,(function(e){"use strict";const t="undefined"!=typeof RTCPeerConnection?RTCPeerConnection:require("wrtc").RTCPeerConnection;class s{constructor(e){this._callback=null,this.incomingStream=null,this.outgoingStream=null,this._rtc=e,this._offerToReceive=!1}subscribe(e){this._callback=e,this.offerToReceive()}putSubscription(e){this.outgoingStream=e,this._rtc.addTrack(e)}offerToReceive(){this._offerToReceive=!0}_onTrack(e){this.incomingStream=e.streams[0],null!=this._callback&&this._callback(e.streams[0])}}var i=new class{constructor(){this._gamepads=[],this._prev=[],this._interval=null,this._mswait=100}loop(){let e=navigator.getGamepads(),t=e.length;this._gamepads.length<t&&(t=this._gamepads.length),this._prev.length<t&&(t=this._prev.length);for(let s=0;s<t;s++)if(null!=this._prev[s]&&null!=this._gamepads[s]&&null!=e[s]){this._gamepads[s].state=e[s];for(let t=0;t<e[s].buttons.length;t++)this._prev[s].buttons[t].pressed!=e[s].buttons[t].pressed&&this._gamepads[s]._subscription({value:e[s].buttons[t].pressed,type:"btn"+t.toString()});for(let t=0;t<e[s].axes.length;t++)this._prev[s].axes[t]!=e[s].axes[t]&&this._gamepads[s]._subscription({value:e[s].axes[t],type:"axis"+t.toString()})}this._prev=e}init(){let e=!1;for(let t=0;t<this._gamepads.length;t++)if(null!=this._gamepads[t]){e=!0;break}e&&null==this._interval?this._interval=setInterval(this.loop.bind(this),this._mswait):e||null==this._interval||(clearInterval(this._interval),this._interval=null)}addGamepad(e){for(let t=0;t<this._gamepads.length;t++)if(null==this._gamepads[t])return this._gamepads[t]=e,void this.init();this._gamepads.push(e),this.init()}removeGamepad(e){for(let t=0;t<this._gamepads.length;t++)if(e==this._gamepads[t])return void(this._gamepads[t]=null)}};e.Gamepad=class{constructor(){this._subscription=console.log,i.addGamepad(this),this.state=null}subscribe(e){this._subscription=e}close(){i.removeGamepad(this)}},e.Keyboard=class{constructor(){this._de=this._downEvent.bind(this),this._ue=this._upEvent.bind(this),window.addEventListener("keydown",this._de),window.addEventListener("keyup",this._ue),this._subscription=console.log}_downEvent(e){e.repeat||this._subscription({type:e.type,altKey:e.altKey,shiftKey:e.shiftKey,keyCode:e.keyCode,key:e.key,timestamp:e.timestamp}),e.preventDefault()}_upEvent(e){this._subscription({type:e.type,altKey:e.altKey,shiftKey:e.shiftKey,keyCode:e.keyCode,key:e.key,timestamp:e.timestamp}),e.preventDefault()}subscribe(e){this._subscription=e}close(){window.removeEventListener("keydown",this._de),window.removeEventListener("keyup",this._ue)}},e.Queue=class{constructor(){this._waiting=[],this._enqueued=[]}put_nowait(e){this._enqueued.push(e),this._waiting.length>0&&this._waiting.shift()(this._enqueued.shift())}async get(){if(this._enqueued.length>0)return this._enqueued.shift();let e=this;return new Promise((function(t,s){e._waiting.push(t)}))}},e.RTCConnection=class{constructor(e=!0,i={iceServers:[{urls:["stun:stun.l.google.com:19302"]}]}){this._dataChannels={},this._msgcallback=e=>console.log(e),this._rtc=new t(i),this._rtc.ondatachannel=this._onDataChannel.bind(this),this._rtc.ontrack=this._onTrack.bind(this),this.video=new s(this._rtc),this.audio=new s(this._rtc),this._hasRemoteDescription=!1,this._defaultChannel=null,this._defaultOrdered=e,this.__queuedMessages=[],this.put_nowait=this.put_nowait.bind(this)}async _waitForICECandidates(){const e=this._rtc;await new Promise((function(t){if("complete"===e.iceGatheringState)t();else{e.addEventListener("icegatheringstatechange",(function s(){"complete"===e.iceGatheringState&&(e.removeEventListener("icegatheringstatechange",s),t())}))}}))}async getLocalDescription(e=null){if(this._hasRemoteDescription||null!=e){this._hasRemoteDescription||await this.setRemoteDescription(e);let t=await this._rtc.createAnswer();return await this._rtc.setLocalDescription(t),await this._waitForICECandidates(),{sdp:this._rtc.localDescription.sdp,type:this._rtc.localDescription.type}}this._defaultChannel=this._rtc.createDataChannel("default",{ordered:this._defaultOrdered}),this._defaultChannel.onmessage=this._onMessage.bind(this,this._defaultChannel),this._defaultChannel.onopen=this._sendQueuedMessages.bind(this);let t=await this._rtc.createOffer({offerToReceiveVideo:this.video._offerToReceive,offerToReceiveAudio:this.audio._offerToReceive});return await this._rtc.setLocalDescription(t),await this._waitForICECandidates(),this._rtc.localDescription}async setRemoteDescription(e){await this._rtc.setRemoteDescription(e),this._hasRemoteDescription=!0}_sendQueuedMessages(){if(this.__queuedMessages.length>0){for(let e=0;e<this.__queuedMessages.length;e++)this._defaultChannel.send(this.__queuedMessages[e]);this.__queuedMessages=[]}}_onDataChannel(e){console.log(e),(e=e.channel).onmessage=this._onMessage.bind(this,e),"default"==e.label?(this._defaultChannel=e,e.onopen=()=>this._sendQueuedMessages()):e.onopen=()=>this._dataChannels[e.label]=e}_onTrack(e){switch(e.track.kind){case"video":this.video._onTrack(e);break;case"audio":this.audio._onTrack(e);break;default:console.error("Could not recognize track!")}}_onMessage(e,t){this._msgcallback(t.data)}subscribe(e){this._msgcallback=e}put_nowait(e){"string"!=typeof e&&(e=JSON.stringify(e)),null!=this._defaultChannel&&"open"==this._defaultChannel.readyState&&0==this.__queuedMessages.length?this._defaultChannel.send(e):this.__queuedMessages.push(e)}async close(){for(let e in this._dataChannels)e.close();null!=this._defaultChannel&&this._defaultChannel.close(),await this._rtc.close()}},e.Websocket=class{constructor(e){this._subscription=console.log,this._ws=WebSocket(e),this._ws.onmessage=this._onMessage,this._ws.onopen=this._onopen,this._msgQueue=[]}_onMessage(e){this._subscription(e)}_onopen(){console.log("opened websocket");for(let e=0;e<this._msgQueue.length;e++)this._ws.send(this._msgQueue[e]);this._msgQueue=[]}put_nowait(e){"string"!=typeof e&&(e=JSON.stringify(e)),1!=this._ws.readyState||this._msgQueue.length>0?this._msgQueue.push(e):this._ws.send(e)}subscribe(e){this._subscription=e}close(){this._ws.close()}},e.setGamepadRate=function(e){i._mswait=Math.round(1e3/e),null!=i._interval&&(clearInterval(i._interval),i._interval=null),i.init()},Object.defineProperty(e,"__esModule",{value:!0})}));
